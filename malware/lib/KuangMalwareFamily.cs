using dotnet_cyberpunk_challenge_3.malware.lib._lib;

namespace dotnet_cyberpunk_challenge_3.malware.lib
{
    

    public abstract class KuangDaemonFamilyBase
    {
        protected bool IsConnectionTunnelProtected {get;set;}
        protected bool IsConnectionProxyEnabled {get;set;}
        public ArasakaServerConnection CurrentArasakaServerConnection {get;set;}
        public MilitechServerConnection CurrentMilitechServerConnection {get;set;}
        public IceBreakerArasakaTunnelConnection CurrentIceBreakerArasakaTunnelConnection {get;set;}
        public IceBreakerMilitechTunnelConnection CurrentIceBreakerMilitechTunnelConnection {get;set;}



        public abstract Task SetupIceBreakerTunnelToTarget(); // Setup the connection tunnel between host and target

        public abstract Task<string> GetIceTypeOnRemote(); // Students need to Get type of ICE on target

        public abstract void IceBreak(); // Students need to Attempt to Break the ICE

        public abstract Task Initialize();

        public virtual Task<List<ArasakaMessageProcessList>> GetArasakaProcessList() {
            throw new NotImplementedException();
        }

        public virtual Task<List<MilitechICEProcessList>> GetMilitechProcessList() {
            throw new NotImplementedException();
        }

        public abstract Task<IEnumerable<string>> GetProcessMemoryMapping(); 



        public async virtual Task<ArasakaServerConnection> GetCurrentArasakaConnection() {
            try {
                if (CurrentArasakaServerConnection != null) {
                    return CurrentArasakaServerConnection;
                } else {
                    throw new Exception("Not Currently connected to an Arasaka Server! Hope your synapses aren't burnt out.");
                }
            } catch {
                CurrentArasakaServerConnection = _EstablishConnectionToArasakaTargetServer();
                await CurrentArasakaServerConnection.Initialize();
                return CurrentArasakaServerConnection;
            }
        }

        public async virtual Task<MilitechServerConnection> GetCurrentMilitechConnection() {
            try {
                if (CurrentMilitechServerConnection != null) {
                    return CurrentMilitechServerConnection;
                } else {
                    throw new Exception("Not Currently connected to an Arasaka Server! Hope your synapses aren't burnt out.");
                }
            } catch {
                CurrentMilitechServerConnection = _EstablishConnectionToMilitechTargetServer();
                await CurrentMilitechServerConnection.Initialize();
                return CurrentMilitechServerConnection;
            }
        }



        protected virtual bool _IsTargetHatichiICE(string retrievedModelType){
            return KnownIceTypes.HITACHI == retrievedModelType;
        }

        protected virtual bool _IsTargetHosakaICE(string retrievedModelType){
            return KnownIceTypes.HOSAKA == retrievedModelType;
        }

        protected virtual bool _IsTargetKiroshiICE(string retrievedModelType){
            return KnownIceTypes.KIROSHI == retrievedModelType;
        }

        protected virtual ArasakaServerConnection _EstablishConnectionToArasakaTargetServer() {
            return new ArasakaServerConnection();
        }

        protected virtual MilitechServerConnection _EstablishConnectionToMilitechTargetServer() {
            return new MilitechServerConnection();
        }

        protected async virtual Task<IceBreakerArasakaTunnelConnection> _EncryptArasakaConnection() {
            IceBreakerArasakaTunnelConnection tunnel = new IceBreakerArasakaTunnelConnection();
            await tunnel.Initialize();
            IsConnectionTunnelProtected = tunnel.IsEncrypted == true && tunnel.TunnelEncryption == EncryptionType.SSL;
            IsConnectionProxyEnabled = tunnel.IsEncrypted;
            return tunnel;
        }

        protected async virtual Task<IceBreakerMilitechTunnelConnection> _EncryptMilitechConnection() {
            IceBreakerMilitechTunnelConnection tunnel = new IceBreakerMilitechTunnelConnection();
            await tunnel.Initialize();
            IsConnectionTunnelProtected = tunnel.IsEncrypted == true && tunnel.TunnelEncryption == EncryptionType.SSL;
            IsConnectionProxyEnabled = tunnel.IsEncrypted;
            return tunnel;
        }
    }
}